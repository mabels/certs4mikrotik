apiVersion: batch/v1
kind: CronJob
metadata:
  name: mikrotik-cert-upload
  namespace: default
spec:
  concurrencyPolicy: Allow
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - command:
            - /bin/bash
            - -c
            - |
              set -xe

              # Install Python dependencies
              pip install librouteros paramiko scp kubernetes

              # Run the complete upload script
              python3 /scripts/upload-router-complete.py \
                --config /config/routers.json \
                --namespace default \
                --issuer letsencrypt-prod \
                --domain-suffix .adviser.com \
                --verbose
            image: python:3.11-slim
            imagePullPolicy: IfNotPresent
            name: cert-uploader
            resources: {}
            terminationMessagePath: /dev/termination-log
            terminationMessagePolicy: File
            volumeMounts:
            - mountPath: /scripts
              name: upload-script
              readOnly: true
            - mountPath: /config
              name: router-config
              readOnly: true
          dnsPolicy: ClusterFirst
          restartPolicy: OnFailure
          schedulerName: default-scheduler
          securityContext: {}
          serviceAccount: mikrotik-cert-uploader
          serviceAccountName: mikrotik-cert-uploader
          terminationGracePeriodSeconds: 30
          volumes:
          - configMap:
              defaultMode: 420
              name: upload-router-complete-script
            name: upload-script
          - configMap:
              defaultMode: 420
              name: mikrotik-routers-config
            name: router-config
  schedule: 0 2 * * 0,3
  successfulJobsHistoryLimit: 3
  suspend: false
